@model CodeSparkNET.ViewModels.AdminCourse.EditCourseViewModel
@{
  ViewData["Title"] = "Edit Course - " + Model?.Name;
  ViewData["App"] = "CodeSparkAdmin";
}

@section Styles {
  <link rel="stylesheet" href="~/css/Style/editCourse.css">
}

<div id="container">
  <h2>Edit course: Demo Course Name</h2>

  <form id="courseBasicsForm" method="post" novalidate>
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    <input type="hidden" id="CourseSlug" value="@Model.Slug" />

    <div>
      <div>
        <label asp-for="Name"></label><br />
        <input asp-for="Name" id="CourseName" />
      </div>

      <div>
        <label asp-for="Slug"></label><br />
        <input asp-for="Slug" id="CourseSlugInput" />
      </div>

      <div>
        <label asp-for="ShortDescription"></label><br />
        <textarea asp-for="ShortDescription" id="ShortDescription"></textarea>
      </div>

      <div>
        <label asp-for="FullDescription"></label><br />
        <textarea asp-for="FullDescription" id="FullDescription"></textarea>
      </div>

      <div>
        <label asp-for="MainImageUrl"></label><br />
        <input asp-for="MainImageUrl" id="MainImageUrl" />
      </div>

      <div>
        <div id="imagePreviewWrap" @(string.IsNullOrWhiteSpace(Model?.MainImageUrl) ? "hidden" : "")>
          <img id="imgPreview" src="@(Model?.MainImageUrl ?? "")" alt="Preview" />
        </div>
      </div>

      <div>
        <button id="btnSaveBasics" type="submit">Save basics</button>
        <button id="btnAddModule" type="button">+ Add Module</button>
      </div>
    </div>
  </form>

  <hr />

  <div>
    <h4>📚 Modules & Lessons</h4>
    <div id="modulesContainer">
      <div>Loading modules...</div>
    </div>
  </div>
</div>

<!-- Module Modal -->
<div id="moduleModalOverlay" hidden data-modal-overlay>
  <div id="moduleDialog">
    <form id="moduleForm" onsubmit="return false;">
      <div class="modal-header">
        <strong>Edit Module</strong>
        <button type="button" data-close="moduleModalOverlay">✕</button>
      </div>

      <div style="margin: 20px 0;">
        <input type="hidden" id="modalModuleSlug" />
        <div style="margin-bottom: 15px;">
          <label>Title</label>
          <input type="text" id="modalModuleTitle" />
        </div>
        <div>
          <label>Position</label>
          <input type="number" id="modalModulePosition" value="0" />
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="btnSaveModule" type="button">💾 Save</button>
        <button type="button" data-close="moduleModalOverlay">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Lesson Modal (Full Screen) -->
<div id="lessonModalOverlay" hidden data-modal-overlay>
  <div id="lessonDialog">
    <form id="lessonForm" onsubmit="return false;">
      <div class="modal-header">
        <strong>📝 Edit Lesson</strong>
        <button type="button" data-close="lessonModalOverlay">✕</button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="modalLessonId" />
        <input type="hidden" id="modalLessonModuleId" />

        <div class="form-row">
          <div>
            <label>Title</label>
            <input type="text" id="modalLessonTitle" />
          </div>
          <div>
            <label>Slug</label>
            <input type="text" id="modalLessonSlug" />
          </div>
          <div>
            <label>Position</label>
            <input type="number" id="modalLessonPosition" />
          </div>
        </div>

        <div style="margin: 15px 0; display: flex; gap: 20px;">
          <label style="display: flex; align-items: center; gap: 8px;">
            <input id="modalLessonPublished" type="checkbox" style="width: auto;" />
            Published
          </label>
          <label style="display: flex; align-items: center; gap: 8px;">
            <input id="modalLessonFree" type="checkbox" style="width: auto;" />
            Free preview
          </label>
        </div>

        <div class="lesson-editor-container">
          <div class="editor-panel">
            <div class="editor-toolbar">
              <button class="toolbar-btn" data-format="undo" title="Undo (Ctrl+Z)">↶</button>
              <button class="toolbar-btn" data-format="redo" title="Redo (Ctrl+Y)">↷</button>
              <button class="toolbar-btn" data-format="clear" title="Clear styles">🧹</button>
              <div class="toolbar-separator"></div>
              <button class="toolbar-btn" data-format="bold" title="Bold"><b>B</b></button>
              <button class="toolbar-btn" data-format="italic" title="Italic"><i>I</i></button>
              <button class="toolbar-btn" data-format="strong" title="Strong"><b>S</b></button>
              <div class="toolbar-separator"></div>
              <button class="toolbar-btn" data-format="h3" title="Heading 3">H3</button>
              <button class="toolbar-btn" data-format="h4" title="Heading 4">H4</button>
              <div class="toolbar-separator"></div>
              <button class="toolbar-btn" data-format="list" title="Lists">L</button>
              <button class="toolbar-btn" data-format="code" title="Code">📟</button>
              <button class="toolbar-btn" data-format="image" title="Image">🖼</button>
              <button class="toolbar-btn" data-format="table" title="Table">📊</button>
            </div>

            <!-- NEW: visual editor (WYSIWYG) -->
            <div id="modalLessonVisual" class="visual-editor" contenteditable="true" aria-label="Visual lesson editor">
            </div>

            <!-- Hidden textarea still used for server submission (do not remove) -->
            <textarea id="modalLessonHtml" name="Body" style="display:none"></textarea>
          </div>

          <!-- RIGHT: HTML code view (read-only) -->
          <div class="editor-panel">
            <div
              style="padding: 15px; background: rgba(255, 255, 255, 0.08); border-bottom: 2px solid var(--palette-acient);">
              <strong style="color: var(--palette-custom);">👁 HTML Source</strong>
            </div>
            <pre id="lessonCodeView" class="html-code-preview" spellcheck="false"></pre>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="btnSaveLesson" type="button">💾 Save lesson</button>
        <button type="button" data-close="lessonModalOverlay">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Dropdowns (keep same) -->
<div id="listDropdown" class="dropdown-menu">
  <button data-list-type="ul">⋮ Unordered List</button>
  <button data-list-type="ol">≡ Ordered List</button>
</div>

<div id="codeDropdown" class="dropdown-menu">
  <button data-code-type="output">Output</button>
  <button data-code-type="console">Console</button>
  <button data-code-type="code">Code</button>
</div>

<div id="tableDropdown" class="dropdown-menu">
  <div style="padding: 10px 0; color: var(--palette-text-shadow);">Select table size:</div>
  <div class="table-picker" id="tablePicker"></div>
  <div style="margin-top: 10px; text-align: center; color: var(--palette-custom);" id="tableSize">1x1</div>
</div>

@section ScriptsMain {
  <script data-src="@(Url.Content("~/js/api/editCourse.js"))" type="text/plain"></script>
  <partial name="_ValidationScriptsPartial" />
}